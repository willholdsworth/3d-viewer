<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR Viewer</title>
    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      canvas {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
      }
    </style>
  </head>
  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/GLTFLoader.min.js"></script>
    <script>
      if (!navigator.xr) {
        alert('WebXR is not supported on this device.');
      }

      let scene, camera, renderer, controller, model;
      let xrSession = null;

      async function initAR() {
        // Set up the scene
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

        // Set up the renderer
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Set up WebXR session
        const xrButton = document.createElement('button');
        xrButton.innerText = 'Enter AR';
        xrButton.style.position = 'absolute';
        xrButton.style.top = '20px';
        xrButton.style.left = '20px';
        document.body.appendChild(xrButton);
        xrButton.onclick = startAR;

        // Load .glb model
        const loader = new THREE.GLTFLoader();
        loader.load('your_model.glb', function (gltf) {
          model = gltf.scene;
          model.scale.set(0.5, 0.5, 0.5); // Adjust size if needed
          scene.add(model);
        });

        // Animation loop
        animate();
      }

      function animate() {
        renderer.render(scene, camera);
        if (model) {
          model.rotation.y += 0.01; // Rotate model for some basic animation
        }
        if (xrSession) {
          xrSession.update();
        }
        requestAnimationFrame(animate);
      }

      async function startAR() {
        const session = await navigator.xr.requestSession('immersive-ar', {
          requiredFeatures: ['hit-test'],
        });
        xrSession = session;
        xrSession.addEventListener('end', onXRSessionEnded);

        const referenceSpace = await xrSession.requestReferenceSpace('local');
        xrSession.requestAnimationFrame(onXRFrame);

        const hitTestSource = await xrSession.requestHitTestSource({
          space: referenceSpace,
        });

        function onXRFrame(t, frame) {
          const pose = frame.getViewerPose(referenceSpace);
          if (pose) {
            camera.position.set(pose.transform.position.x, pose.transform.position.y, pose.transform.position.z);
            renderer.render(scene, camera);
          }

          xrSession.requestAnimationFrame(onXRFrame);
        }

        function onXRSessionEnded() {
          xrSession = null;
        }
      }

      initAR();
    </script>
  </body>
</html>
